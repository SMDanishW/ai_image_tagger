<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Tag Viewer ‚Äî Gemini vs OpenAI</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0f13;
    --surface: #16171d;
    --surface-alt: #1c1d25;
    --border: #2a2b36;
    --border-hover: #3d3e4e;
    --text: #e2e4ed;
    --text-dim: #8b8ea0;
    --accent-openai: #10a37f;
    --accent-openai-bg: rgba(16, 163, 127, 0.08);
    --accent-openai-border: rgba(16, 163, 127, 0.25);
    --accent-gemini: #4285f4;
    --accent-gemini-bg: rgba(66, 133, 244, 0.08);
    --accent-gemini-border: rgba(66, 133, 244, 0.25);
    --radius: 10px;
    --radius-sm: 6px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #setup-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    padding: 2rem;
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 3rem;
    max-width: 520px;
    width: 100%;
  }

  .setup-card h1 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
    letter-spacing: -0.02em;
  }

  .setup-card .subtitle {
    color: var(--text-dim);
    font-size: 0.9rem;
    margin-bottom: 2rem;
  }

  .input-group { margin-bottom: 1.5rem; }

  .input-group label {
    display: block;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
  }

  .file-drop {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 1.4rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg);
  }

  .file-drop:hover { border-color: var(--accent-gemini); background: var(--accent-gemini-bg); }

  .file-drop.has-file {
    border-color: var(--accent-openai);
    border-style: solid;
    background: var(--accent-openai-bg);
  }

  .file-drop input { display: none; }
  .file-drop .drop-text { font-size: 0.88rem; color: var(--text-dim); }
  .file-drop .drop-text strong { color: var(--text); }

  .file-drop .file-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    color: var(--accent-openai);
  }

  .btn-launch {
    width: 100%;
    padding: 0.9rem;
    border: none;
    border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(135deg, var(--accent-gemini), var(--accent-openai));
    color: #fff;
    transition: opacity 0.2s;
    margin-top: 0.5rem;
  }

  .btn-launch:hover { opacity: 0.9; }
  .btn-launch:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARED TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.7rem 1.4rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .topbar-left, .topbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .topbar .nav-info {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .topbar .nav-info strong { color: var(--text); }

  .nav-btns { display: flex; gap: 0.5rem; }

  .nav-btns button, .view-toggle button {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    padding: 0.45rem 1rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.15s;
  }

  .nav-btns button:hover, .view-toggle button:hover { border-color: var(--text-dim); }

  /* View toggle */
  .view-toggle {
    display: flex;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .view-toggle button {
    border: none;
    border-radius: 0;
    padding: 0.45rem 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.78rem;
  }

  .view-toggle button + button { border-left: 1px solid var(--border); }

  .view-toggle button.active {
    background: var(--accent-gemini);
    color: #fff;
  }

  .view-toggle button svg {
    width: 14px; height: 14px;
    stroke: currentColor; fill: none;
    stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
  }

  .divider-v { width: 1px; height: 24px; background: var(--border); }

  /* Search */
  .search-box { position: relative; }

  .search-box input {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    padding: 0.45rem 0.8rem 0.45rem 2rem;
    border-radius: var(--radius-sm);
    width: 200px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-box input:focus { border-color: var(--accent-gemini); }

  .search-box svg {
    position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%);
    width: 14px; height: 14px; stroke: var(--text-dim); fill: none; stroke-width: 2;
  }

  /* Size slider */
  .size-control { display: flex; align-items: center; gap: 0.5rem; }

  .size-control label {
    font-size: 0.72rem; color: var(--text-dim); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.04em;
  }

  .size-control input[type="range"] { width: 80px; accent-color: var(--accent-gemini); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #detail-view {
    display: none;
    height: calc(100vh - 48px);
    grid-template-columns: 420px 1fr;
  }

  .tags-panel {
    overflow-y: auto;
    padding: 1.4rem;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .print-id-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.92rem;
    padding: 0.6rem 0.9rem;
    background: var(--bg);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    word-break: break-all;
  }

  .provider-section { border-radius: var(--radius); padding: 1rem 1.1rem; border: 1px solid; }
  .provider-section.openai { background: var(--accent-openai-bg); border-color: var(--accent-openai-border); }
  .provider-section.gemini { background: var(--accent-gemini-bg); border-color: var(--accent-gemini-border); }

  .provider-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.9rem; }

  .provider-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .openai .provider-dot { background: var(--accent-openai); box-shadow: 0 0 8px var(--accent-openai); }
  .gemini .provider-dot { background: var(--accent-gemini); box-shadow: 0 0 8px var(--accent-gemini); }

  .provider-header span { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
  .openai .provider-header span { color: var(--accent-openai); }
  .gemini .provider-header span { color: var(--accent-gemini); }

  .tag-row { margin-bottom: 0.75rem; }
  .tag-row:last-child { margin-bottom: 0; }

  .tag-label {
    font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--text-dim); margin-bottom: 0.3rem;
  }

  .tag-value { font-size: 0.88rem; line-height: 1.5; color: var(--text); }

  .image-panel {
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; background: var(--bg);
  }

  .image-panel img {
    max-width: 95%; max-height: 95%; object-fit: contain;
    border-radius: var(--radius); box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  }

  .image-panel .no-image, .no-thumb {
    color: var(--text-dim); font-size: 0.9rem; text-align: center;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GRID VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #grid-view {
    display: none;
    height: calc(100vh - 48px);
    overflow-y: auto;
    padding: 1.4rem;
  }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
  }

  /* Grid card */
  .grid-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s, box-shadow 0.2s;
  }

  .grid-card:hover {
    border-color: var(--border-hover);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }

  .grid-card .card-thumb {
    width: 100%; aspect-ratio: 4/3; overflow: hidden;
    background: var(--bg); display: flex; align-items: center; justify-content: center;
  }

  .grid-card .card-thumb img {
    width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;
  }

  .grid-card:hover .card-thumb img { transform: scale(1.04); }

  .grid-card .card-body { padding: 0.8rem 1rem; }

  .grid-card .card-title {
    font-family: 'JetBrains Mono', monospace; font-size: 0.78rem;
    margin-bottom: 0.55rem; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; color: var(--text);
  }

  .card-tags { display: flex; gap: 0.6rem; }
  .card-tag-group { flex: 1; min-width: 0; }

  .card-tag-provider {
    font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.06em; margin-bottom: 0.25rem;
  }

  .card-tag-provider.openai { color: var(--accent-openai); }
  .card-tag-provider.gemini { color: var(--accent-gemini); }

  .card-tag-pills { display: flex; flex-wrap: wrap; gap: 0.25rem; }

  .pill {
    font-size: 0.65rem; padding: 0.15rem 0.45rem; border-radius: 99px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;
  }

  .pill.openai { background: var(--accent-openai-bg); border: 1px solid var(--accent-openai-border); color: var(--accent-openai); }
  .pill.gemini { background: var(--accent-gemini-bg); border: 1px solid var(--accent-gemini-border); color: var(--accent-gemini); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIST LAYOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .grid-container.list-layout {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }

  .list-layout .grid-card {
    display: grid;
    grid-template-columns: 170px 1fr;
  }

  .list-layout .grid-card .card-thumb { aspect-ratio: unset; height: 110px; }

  .list-layout .grid-card .card-body {
    display: flex; align-items: center; gap: 1.5rem; padding: 0.8rem 1.2rem;
  }

  .list-layout .grid-card .card-title {
    margin-bottom: 0; min-width: 130px; flex-shrink: 0;
  }

  .list-layout .card-tags { flex: 1; gap: 1.5rem; }

  .lp-label {
    font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.06em; margin-bottom: 0.15rem;
  }

  .lp-label.openai { color: var(--accent-openai); }
  .lp-label.gemini { color: var(--accent-gemini); }

  .lp-item { font-size: 0.75rem; color: var(--text-dim); line-height: 1.45; }
  .lp-item strong { color: var(--text); font-weight: 500; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
    align-items: center; justify-content: center; padding: 2rem;
  }

  #modal-overlay.show { display: flex; }

  .modal-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; max-width: 1100px; width: 100%; max-height: 90vh;
    display: grid; grid-template-columns: 1fr 380px; overflow: hidden;
  }

  .modal-image {
    display: flex; align-items: center; justify-content: center;
    background: var(--bg); padding: 1.5rem; min-height: 400px;
  }

  .modal-image img {
    max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: var(--radius-sm);
  }

  .modal-sidebar {
    padding: 1.4rem; overflow-y: auto; border-left: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 1rem;
  }

  .modal-close {
    position: absolute; top: 1rem; right: 1rem;
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-size: 1.2rem;
    width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; z-index: 101;
  }

  .modal-close:hover { border-color: var(--text-dim); }

  .btn-modal-detail {
    margin-top: auto; padding: 0.6rem; border: 1px solid var(--border);
    border-radius: var(--radius-sm); background: var(--bg); color: var(--text);
    font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.82rem; cursor: pointer;
    transition: all 0.15s;
  }

  .btn-modal-detail:hover { border-color: var(--text-dim); }

  .key-hint {
    font-family: 'JetBrains Mono', monospace; font-size: 0.68rem;
    color: var(--text-dim); background: var(--bg); padding: 0.2rem 0.45rem;
    border-radius: 4px; border: 1px solid var(--border); margin-left: 0.3rem;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCROLLBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- SETUP -->
<div id="setup-screen">
  <div class="setup-card">
    <h1>Image Tag Viewer</h1>
    <p class="subtitle">Compare OpenAI and Gemini tags side-by-side with your images.</p>
    <div class="input-group">
      <label>Image Folder</label>
      <div class="file-drop" id="folder-drop" onclick="document.getElementById('folder-input').click()">
        <input type="file" id="folder-input" webkitdirectory multiple>
        <div class="drop-text">Click to select <strong>image folder</strong></div>
      </div>
    </div>
    <div class="input-group">
      <label>CSV File</label>
      <div class="file-drop" id="csv-drop" onclick="document.getElementById('csv-input').click()">
        <input type="file" id="csv-input" accept=".csv">
        <div class="drop-text">Click to select <strong>.csv file</strong></div>
      </div>
    </div>
    <button class="btn-launch" id="btn-launch" disabled>Launch Viewer</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-screen" style="display:none; height:100vh; flex-direction:column;">

  <div class="topbar">
    <div class="topbar-left">
      <div class="view-toggle">
        <button id="btn-grid" class="active" onclick="switchView('grid')">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Grid
        </button>
        <button id="btn-list" onclick="switchView('list')">
          <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          List
        </button>
        <button id="btn-detail" onclick="switchView('detail')">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          Detail
        </button>
      </div>

      <div class="divider-v"></div>

      <div class="nav-info" id="nav-info-wrap" style="display:none;">
        <strong id="current-idx">1</strong> / <span id="total-count">0</span>
        <span class="key-hint">‚Üê</span> <span class="key-hint">‚Üí</span>
      </div>

      <div class="nav-info" id="grid-count-wrap">
        <strong id="grid-shown">0</strong> / <span id="grid-total">0</span> images
      </div>
    </div>

    <div class="topbar-right">
      <div class="size-control" id="size-control">
        <label>Size</label>
        <input type="range" min="160" max="420" value="260" id="grid-size-slider" oninput="updateGridSize(this.value)">
      </div>

      <div class="divider-v"></div>

      <div class="search-box">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="search-input" placeholder="Search Print ID..." oninput="onSearch()">
      </div>

      <div class="nav-btns" id="nav-btns-wrap" style="display:none;">
        <button onclick="prev()">‚óÄ Prev</button>
        <button onclick="next()">Next ‚ñ∂</button>
      </div>
    </div>
  </div>

  <div id="detail-view">
    <div class="tags-panel" id="tags-panel"></div>
    <div class="image-panel" id="image-panel"></div>
  </div>

  <div id="grid-view">
    <div class="grid-container" id="grid-container"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <button class="modal-close" onclick="closeModal(event, true)">‚úï</button>
  <div class="modal-card" id="modal-card"></div>
</div>

<script>
  let csvData = [];
  let filteredData = [];
  let imageFiles = {};
  let currentIndex = 0;
  let currentView = 'grid';

  const folderInput = document.getElementById('folder-input');
  const csvInput = document.getElementById('csv-input');
  const folderDrop = document.getElementById('folder-drop');
  const csvDrop = document.getElementById('csv-drop');
  const btnLaunch = document.getElementById('btn-launch');

  folderInput.addEventListener('change', () => {
    const files = folderInput.files;
    if (!files.length) return;
    imageFiles = {};
    const imgExts = ['.png','.jpg','.jpeg','.gif','.webp','.bmp','.tiff','.tif','.svg'];
    for (const f of files) {
      const name = f.name;
      const ext = name.substring(name.lastIndexOf('.')).toLowerCase();
      if (imgExts.includes(ext)) {
        imageFiles[name] = URL.createObjectURL(f);
        const baseName = name.substring(0, name.lastIndexOf('.'));
        if (!imageFiles[baseName]) imageFiles[baseName] = URL.createObjectURL(f);
      }
    }
    const count = new Set(Object.values(imageFiles)).size;
    folderDrop.classList.add('has-file');
    folderDrop.querySelector('.drop-text').innerHTML = `<span class="file-name">${count} images loaded</span>`;
    checkReady();
  });

  csvInput.addEventListener('change', () => {
    const file = csvInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      csvData = parseCSV(e.target.result);
      filteredData = [...csvData];
      csvDrop.classList.add('has-file');
      csvDrop.querySelector('.drop-text').innerHTML = `<span class="file-name">${file.name} (${csvData.length} rows)</span>`;
      checkReady();
    };
    reader.readAsText(file);
  });

  function checkReady() {
    btnLaunch.disabled = !(csvData.length && Object.keys(imageFiles).length);
  }

  btnLaunch.addEventListener('click', () => {
    document.getElementById('setup-screen').style.display = 'none';
    const app = document.getElementById('app-screen');
    app.style.display = 'flex';
    filteredData = [...csvData];
    document.getElementById('total-count').textContent = csvData.length;
    document.getElementById('grid-total').textContent = csvData.length;
    currentIndex = 0;
    switchView('grid');
  });

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = parseCSVLine(lines[0]);
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = parseCSVLine(lines[i]);
      if (vals.length < headers.length) continue;
      const obj = {};
      headers.forEach((h, idx) => obj[h.trim()] = (vals[idx] || '').trim());
      rows.push(obj);
    }
    return rows;
  }

  function parseCSVLine(line) {
    const result = []; let current = ''; let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (inQuotes) {
        if (ch === '"' && line[i+1] === '"') { current += '"'; i++; }
        else if (ch === '"') inQuotes = false;
        else current += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') { result.push(current); current = ''; }
        else current += ch;
      }
    }
    result.push(current);
    return result;
  }

  function findImage(printId) {
    if (!printId) return null;
    if (imageFiles[printId]) return imageFiles[printId];
    const exts = ['.png','.jpg','.jpeg','.gif','.webp','.bmp','.tiff','.tif'];
    for (const ext of exts) { if (imageFiles[printId + ext]) return imageFiles[printId + ext]; }
    const lower = printId.toLowerCase();
    for (const key of Object.keys(imageFiles)) {
      if (key.toLowerCase() === lower || key.toLowerCase().startsWith(lower + '.')) return imageFiles[key];
    }
    return null;
  }

  function onSearch() {
    const q = document.getElementById('search-input').value.toLowerCase().trim();
    filteredData = q ? csvData.filter(r => {
      const pid = (r['Print ID'] || '').toLowerCase();
      const ot = (r['openai_Theme'] || '').toLowerCase();
      const om = (r['openai_Motifs'] || '').toLowerCase();
      const os = (r['openai_Style'] || '').toLowerCase();
      const gt = (r['gemini_Theme'] || '').toLowerCase();
      const gm = (r['gemini_Motifs'] || '').toLowerCase();
      const gs = (r['gemini_Style'] || '').toLowerCase();
      return pid.includes(q) || ot.includes(q) || om.includes(q) || os.includes(q)
          || gt.includes(q) || gm.includes(q) || gs.includes(q);
    }) : [...csvData];
    currentIndex = 0;
    renderCurrentView();
  }

  function switchView(view) {
    currentView = view;
    document.getElementById('btn-grid').classList.toggle('active', view === 'grid');
    document.getElementById('btn-list').classList.toggle('active', view === 'list');
    document.getElementById('btn-detail').classList.toggle('active', view === 'detail');

    document.getElementById('detail-view').style.display = view === 'detail' ? 'grid' : 'none';
    document.getElementById('grid-view').style.display = (view === 'grid' || view === 'list') ? 'block' : 'none';

    document.getElementById('nav-info-wrap').style.display = view === 'detail' ? '' : 'none';
    document.getElementById('nav-btns-wrap').style.display = view === 'detail' ? '' : 'none';
    document.getElementById('grid-count-wrap').style.display = view !== 'detail' ? '' : 'none';
    document.getElementById('size-control').style.display = view === 'grid' ? '' : 'none';

    renderCurrentView();
  }

  function renderCurrentView() {
    if (currentView === 'detail') renderDetail();
    else renderGrid();
  }

  function renderDetail() {
    if (!filteredData.length) return;
    const row = filteredData[currentIndex];
    document.getElementById('current-idx').textContent = currentIndex + 1;
    document.getElementById('total-count').textContent = filteredData.length;
    const printId = row['Print ID'] || '';

    document.getElementById('tags-panel').innerHTML = `
      <div class="print-id-label">üñº ${esc(printId)}</div>
      <div class="provider-section openai">
        <div class="provider-header"><div class="provider-dot"></div><span>OpenAI</span></div>
        <div class="tag-row"><div class="tag-label">Theme</div><div class="tag-value">${esc(row['openai_Theme'])}</div></div>
        <div class="tag-row"><div class="tag-label">Motifs</div><div class="tag-value">${esc(row['openai_Motifs'])}</div></div>
        <div class="tag-row"><div class="tag-label">Style</div><div class="tag-value">${esc(row['openai_Style'])}</div></div>
      </div>
      <div class="provider-section gemini">
        <div class="provider-header"><div class="provider-dot"></div><span>Gemini</span></div>
        <div class="tag-row"><div class="tag-label">Theme</div><div class="tag-value">${esc(row['gemini_Theme'])}</div></div>
        <div class="tag-row"><div class="tag-label">Motifs</div><div class="tag-value">${esc(row['gemini_Motifs'])}</div></div>
        <div class="tag-row"><div class="tag-label">Style</div><div class="tag-value">${esc(row['gemini_Style'])}</div></div>
      </div>`;

    const imgUrl = findImage(printId);
    document.getElementById('image-panel').innerHTML = imgUrl
      ? `<img src="${imgUrl}" alt="${esc(printId)}">`
      : `<div class="no-image">No image found for<br><strong>${esc(printId)}</strong></div>`;
  }

  function renderGrid() {
    const container = document.getElementById('grid-container');
    const isList = currentView === 'list';
    container.classList.toggle('list-layout', isList);

    document.getElementById('grid-shown').textContent = filteredData.length;
    document.getElementById('grid-total').textContent = csvData.length;

    let html = '';
    filteredData.forEach((row, idx) => {
      const printId = row['Print ID'] || '';
      const imgUrl = findImage(printId);
      const thumbHtml = imgUrl
        ? `<img src="${imgUrl}" alt="${esc(printId)}" loading="lazy">`
        : `<span class="no-thumb">No image</span>`;

      if (isList) {
        html += `
          <div class="grid-card" onclick="openModal(${idx})">
            <div class="card-thumb">${thumbHtml}</div>
            <div class="card-body">
              <div class="card-title" title="${esc(printId)}">${esc(printId)}</div>
              <div class="card-tags">
                <div class="card-tag-group">
                  <div class="lp-label openai">OpenAI</div>
                  <div class="lp-item"><strong>Theme:</strong> ${esc(row['openai_Theme']) || '‚Äî'}</div>
                  <div class="lp-item"><strong>Motifs:</strong> ${esc(row['openai_Motifs']) || '‚Äî'}</div>
                  <div class="lp-item"><strong>Style:</strong> ${esc(row['openai_Style']) || '‚Äî'}</div>
                </div>
                <div class="card-tag-group">
                  <div class="lp-label gemini">Gemini</div>
                  <div class="lp-item"><strong>Theme:</strong> ${esc(row['gemini_Theme']) || '‚Äî'}</div>
                  <div class="lp-item"><strong>Motifs:</strong> ${esc(row['gemini_Motifs']) || '‚Äî'}</div>
                  <div class="lp-item"><strong>Style:</strong> ${esc(row['gemini_Style']) || '‚Äî'}</div>
                </div>
              </div>
            </div>
          </div>`;
      } else {
        html += `
          <div class="grid-card" onclick="openModal(${idx})">
            <div class="card-thumb">${thumbHtml}</div>
            <div class="card-body">
              <div class="card-title" title="${esc(printId)}">${esc(printId)}</div>
              <div class="card-tags">
                <div class="card-tag-group">
                  <div class="card-tag-provider openai">OpenAI</div>
                  <div class="card-tag-pills">
                    ${row['openai_Theme'] ? `<span class="pill openai" title="${esc(row['openai_Theme'])}">${esc(trunc(row['openai_Theme'],22))}</span>` : ''}
                    ${row['openai_Style'] ? `<span class="pill openai" title="${esc(row['openai_Style'])}">${esc(trunc(row['openai_Style'],22))}</span>` : ''}
                  </div>
                </div>
                <div class="card-tag-group">
                  <div class="card-tag-provider gemini">Gemini</div>
                  <div class="card-tag-pills">
                    ${row['gemini_Theme'] ? `<span class="pill gemini" title="${esc(row['gemini_Theme'])}">${esc(trunc(row['gemini_Theme'],22))}</span>` : ''}
                    ${row['gemini_Style'] ? `<span class="pill gemini" title="${esc(row['gemini_Style'])}">${esc(trunc(row['gemini_Style'],22))}</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      }
    });

    container.innerHTML = html;
  }

  function updateGridSize(val) {
    if (currentView === 'grid') {
      document.getElementById('grid-container').style.gridTemplateColumns =
        `repeat(auto-fill, minmax(${val}px, 1fr))`;
    }
  }

  // Modal
  function openModal(idx) {
    const row = filteredData[idx];
    if (!row) return;
    const printId = row['Print ID'] || '';
    const imgUrl = findImage(printId);

    document.getElementById('modal-card').innerHTML = `
      <div class="modal-image">
        ${imgUrl ? `<img src="${imgUrl}" alt="${esc(printId)}">` : `<div class="no-image">No image</div>`}
      </div>
      <div class="modal-sidebar">
        <div class="print-id-label">üñº ${esc(printId)}</div>
        <div class="provider-section openai">
          <div class="provider-header"><div class="provider-dot"></div><span>OpenAI</span></div>
          <div class="tag-row"><div class="tag-label">Theme</div><div class="tag-value">${esc(row['openai_Theme'])}</div></div>
          <div class="tag-row"><div class="tag-label">Motifs</div><div class="tag-value">${esc(row['openai_Motifs'])}</div></div>
          <div class="tag-row"><div class="tag-label">Style</div><div class="tag-value">${esc(row['openai_Style'])}</div></div>
        </div>
        <div class="provider-section gemini">
          <div class="provider-header"><div class="provider-dot"></div><span>Gemini</span></div>
          <div class="tag-row"><div class="tag-label">Theme</div><div class="tag-value">${esc(row['gemini_Theme'])}</div></div>
          <div class="tag-row"><div class="tag-label">Motifs</div><div class="tag-value">${esc(row['gemini_Motifs'])}</div></div>
          <div class="tag-row"><div class="tag-label">Style</div><div class="tag-value">${esc(row['gemini_Style'])}</div></div>
        </div>
        <button class="btn-modal-detail" onclick="currentIndex=${idx}; switchView('detail'); closeModal(null, true);">
          Open in Detail View ‚Üí
        </button>
      </div>`;

    document.getElementById('modal-overlay').classList.add('show');
  }

  function closeModal(e, force) {
    if (force || (e && e.target === document.getElementById('modal-overlay')))
      document.getElementById('modal-overlay').classList.remove('show');
  }

  function next() { if (currentIndex < filteredData.length - 1) { currentIndex++; renderDetail(); } }
  function prev() { if (currentIndex > 0) { currentIndex--; renderDetail(); } }

  document.addEventListener('keydown', (e) => {
    if (document.getElementById('modal-overlay').classList.contains('show')) {
      if (e.key === 'Escape') closeModal(null, true);
      return;
    }
    if (e.target.tagName === 'INPUT') return;
    if (currentView === 'detail') {
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
    }
  });

  function esc(s) { return (s || '‚Äî').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function trunc(s, n) { if (!s) return ''; return s.length > n ? s.slice(0, n) + '‚Ä¶' : s; }
</script>
</body>
</html>
